<!DOCTYPE html>
<html>
<head>
	<title>Quinn James Online</title>
	<meta charset="UTF-8">
</head>
<body>
	<div id="parent" style="position:relative; cursor:none; font-family:'Lucida Console', monospace; font-size:12px; line-height:12px; width:151ch; margin:auto;">
		<iframe id=frame src=" " allowfullscreen="" style="top:296px;left:504px;position:absolute;z-index:-1;" width="372" height="225" frameborder="0" scrolling="no"></iframe>
		<img id=image src="" style="top:296px;left:504px;position:absolute;z-index:-1;display:none;" width="372" height="225"/>
		<div id="main"></div>
	</div>
	
	<script>		
		const outputWidth = 150;
		const outputHeight = 50;
		const main = document.getElementById("main");
		const frame = document.getElementById("frame");
		const image = document.getElementById("image");
		const parent = document.getElementById("parent");
		var o = new Array(); //array to be output when blit() is called
		var mouse = {x:0,y:0,oldX:0,oldY:0,under:'┌',cursor:'█'}; //cursor style and location
		var draw = {drawInvert:false,hitbox:0,foreground:"silver",background:"black"}; //display/color related vars
		var hitboxes = []; //all clickables in current frame
		var pageIndex = -1; //current pageID displayed
		var pageImg = true; //display video/image on content draw
		var texts; //json of all texts for content
		var pages; //pages Enabled, posx, posy, width, height, text, [links hitx1, hity1, hitx2, hity2, togglepage, setcontentwindowpage, enablepage, disablepage, openlink]

		var textsReq = new XMLHttpRequest();
		textsReq.addEventListener("load", textsReqListener);
		textsReq.open("GET", "texts.json");
		textsReq.send(null);
		
		function textsReqListener () {
			texts = JSON.parse(this.responseText);
		}
		
		var pagesReq = new XMLHttpRequest();
		pagesReq.addEventListener("load", pagesReqListener);
		pagesReq.open("GET", "pages.json");
		pagesReq.send(null);
		
		function pagesReqListener () {
			pages = JSON.parse(this.responseText);
		}
		
		function start() {
			
			for(var i = 0; i < outputWidth; i++) {
				o.push(new Array(outputHeight));
				for(var j = 0; j < outputWidth; j++) {
					o[i][j] = '#';
				}
			}
			
			for(var i = 0; i < pages.length; i++) {
				for(var j = 0; j < pages[i].links.length; j++) {
					var tempX = pages[i].posX + 1;
					var tempY = pages[i].posY + 1;
					hitboxes.push( [pages[i].links[j][0]+tempX,pages[i].links[j][1]+tempY,pages[i].links[j][2]+tempX,pages[i].links[j][3]+tempY,pages[i].links[j][4],pages[i].links[j][5],pages[i].links[j][6],pages[i].links[j][7],pages[i].links[j][8],i] );
				}
			}
			
			frame.src = "";
			image.style = "top:296px;left:504px;position:absolute;z-index:-1;display: none;";
			document.addEventListener("mousemove",mouseMove);
			document.addEventListener("mousedown",mouseDown);
			document.addEventListener("mouseup",mouseUp);
			document.addEventListener("keydown",keyDown);
			
			update();
			
			var wt = "Welcome. Use the mouse or keyboard to navigate the page.";
			fillspace(outputWidth/2 - wt.length/2,outputHeight/2-1,outputWidth/2 + wt.length/2+1,outputHeight/2+1,true,wt);
			blit();
		}
		
		function mouseMove(evt) {
			mouse.x = Math.min(Math.max(Math.floor((evt.clientX - parent.offsetLeft) / main.clientWidth * outputWidth),0),outputWidth-1);
			mouse.y = Math.min(Math.max(Math.floor((evt.clientY - parent.offsetTop) / main.clientHeight * outputHeight),0),outputHeight-1);
			moveCursorEfficient();
		}
		
		function moveCursorEfficient() {
			o[mouse.oldX][mouse.oldY] = mouse.under;
			mouse.under = o[mouse.x][mouse.y];
			mouse.oldX = mouse.x;
			mouse.oldY = mouse.y;
			o[mouse.x][mouse.y] = mouse.cursor;
			blit();
		}
		
		function mouseDown(evt) {
			for(var i = 0; i < hitboxes.length; i++) {
				if(pages[hitboxes[i][9]].enabled && hitboxes[i][0] <= mouse.x && hitboxes[i][1] <= mouse.y && hitboxes[i][2] >= mouse.x && hitboxes[i][3] >= mouse.y) {
					draw.drawInvert = true;
					draw.hitbox = i;
					if(hitboxes[i][4] != null) {
						for(var j = 0; j < hitboxes[i][4].length; j++) {
							flicker(hitboxes[i][4][j]);
						}
					}
					if(hitboxes[i][5] != null) {
						for(var j = 0; j < hitboxes[i][5].length; j++) {
							setPage(hitboxes[i][5][j]);
						}
					}
					if(hitboxes[i][6] != null) {
						for(var j = 0; j < hitboxes[i][6].length; j++) {
							pages[hitboxes[i][6][j]].enabled=true;
						}
					}
					if(hitboxes[i][7] != null) {
						for(var j = 0; j < hitboxes[i][7].length; j++) {
							pages[hitboxes[i][7][j]].enabled=false;
						}
					}
					if(hitboxes[i][8] != null) {
						for(var j = 0; j < hitboxes[i][8].length; j++) {
							if (hitboxes[i][8][j] == "PAGELINK") getPage();
							else getPage(hitboxes[i][8][j]);
						}
					}
				}
				update();
			}
		}	
		
		function mouseUp(evt) {
			draw.drawInvert = false;
			update();
			moveCursorEfficient();
		}
		
		function keyDown(evt) {
			switch(evt.keyCode) {
				case 38:
				case 73:
				case 87:
				case 104:
					mouse.y = Math.min(Math.max(mouse.y-1,0),outputHeight-1);
					moveCursorEfficient();
				break;
				case 40:
				case 75:
				case 83:
				case 98:
					mouse.y = Math.min(Math.max(mouse.y+1,0),outputHeight-1);
					moveCursorEfficient();
				break;
				case 37:
				case 74:
				case 65:
				case 100:
					mouse.x = Math.min(Math.max(mouse.x-1,0),outputWidth-1);
					moveCursorEfficient();
				break;
				case 39:
				case 76:
				case 68:
				case 102:
					mouse.x = Math.min(Math.max(mouse.x+1,0),outputWidth-1);
					moveCursorEfficient();
				break;
				case 13:
				case 32:
					mouseDown();
					setTimeout(mouseUp,100);
					update();
				break;
			}
			
		}
		
		function text(t, x, y, wrap, maxX) {
			if(typeof wrap === "undefined") wrap = true;
			if(typeof maxX === "undefined") maxX = outputWidth-1;
			var initX = x;
			for(var i = 0; i < t.length; i++) {
				while(t.charAt(i) == '~' && t.charAt(i+1) == 'n') {
					x = initX;
					y++;
					i += 2;
				}
				o[x][y] = t.charAt(i);
				x++;
				if(wrap && x > maxX) {
					x = initX;
					y++;
				}
			}
		}
		
		function fillspace(startX, startY, endX, endY, border, fillchar, invert) {
			if(typeof border === "undefined") border = false;
			if(typeof fillchar === "undefined" || fillchar == "") fillchar = "&nbsp;";
			if(typeof invert === "undefined") invert = false;
			
			if(!invert && fillchar != "~t") {
				if(fillchar.length <= 1 || fillchar == "&nbsp;") {
					for(var i = startX; i <= endX; i++) {
						for(var j = startY; j < endY; j++) {
							o[i][j] = fillchar;
						}
					}
				}
				else {
					for(var i = startX; i <= endX; i++) {
						for(var j = startY; j < endY; j++) {
							o[i][j] = '&nbsp;';
						}
					}
					text(fillchar, startX+1, startY+1, true, endX - 1)
				}
			}
			
			if(border) {
				o[startX][startY] = '┌';
				o[endX][startY] = '┐';
				o[startX][endY] = '└';
				o[endX][endY] = '┘';
				for(var i = startX + 1; i < endX; i++) {
					o[i][startY] = '─';
					o[i][endY] = '─';
				}
				for(var i = startY + 1; i < endY; i++) {
					o[startX][i] = '│';
					o[endX][i] = '│';
				}
			}
			
			if(invert) {
				for(var i = startX; i <= endX; i++) {
					for(var j = startY; j <= endY; j++) {
						o[i][j] = ("<span style='color:" + draw.background + "; background-color:" + draw.foreground + ";'>" + o[i][j] + "</span>");
					}
				}
			}
		}
		
		function flicker(pageId, perms) {
			if(typeof perms === "undefined") perms = 1;
			pages[pageId].enabled = !pages[pageId].enabled;
			update();
			if(perms > 1) setTimeout(flicker,20,pageId,perms-1);
		}
		
		function setPage(index) {
			if(typeof index === "boolean") {
				pageImg = index;
				setPage();
			}
			
			else if(index == pageIndex || index == "CLOSE") {
				pages[11].enabled = false;
				pages[12].enabled = false;
				pages[13].enabled = false;
				pages[14].enabled = false;
				pages[15].enabled = false;
				pageIndex = -1;
				frame.style = "top:296px;left:504px;position:absolute;z-index:-1;";
				frame.src = "";
				image.style = "top:296px;left:504px;position:absolute;z-index:-1;display: none;";
			}
			else {
				if(!(typeof index === "undefined")) {
					pageIndex = index;
					pageImg = false;
				}
				pages[11].enabled = true;
				pages[12].enabled = true;
				pages[13].enabled = true;
				pages[14].enabled = true;
				pages[15].enabled = true;
				pages[11].text = texts[pageIndex][0];
				
				pages[10].enabled = false;
				
				if(texts[pageIndex][1] == "") {
					pages[15].enabled = false;
					pageImg = true;
				}
				
				if(texts[pageIndex][3] == "") {
					pages[14].enabled = false;
					pageImg = false;
				}
				
				frame.style = "top:296px;left:504px;position:absolute;z-index:-1;";
				frame.src = "";
				image.style = "top:296px;left:504px;position:absolute;z-index:-1;display: none;";
				
				if(pageImg) {
					image.src = texts[pageIndex][3];
					image.style = "top:296px;left:504px;position:absolute;z-index:-1;display: inline-block;";
				}
				else {
					frame.style = "top:296px;left:504px;position:absolute;z-index:1;";
					frame.src = texts[pageIndex][1];
				}
			}
			
		}
		
		function getPage(link) {
			if(typeof link === "undefined" && pageIndex > -1) link = texts[pageIndex][2]; 
			window.open(link,'_blank');
			mouseUp();
		}
		
		function update() {
			document.body.style = ("overflow:hidden; color:" + draw.foreground + "; background-color:" + draw.background  + ";");
			fillspace(0,0,outputWidth-1,outputHeight-1,true,'-');			
			for(var i = 0; i < pages.length; i++)
				if(pages[i].enabled)
					fillspace(pages[i].posX, pages[i].posY, pages[i].posX + pages[i].width + 1, pages[i].posY + pages[i].height + 1, true, pages[i].text);
			if(draw.drawInvert) 
				fillspace(hitboxes[draw.hitbox][0]-1,hitboxes[draw.hitbox][1]-1,hitboxes[draw.hitbox][2]+1,hitboxes[draw.hitbox][3]+1,false,'-',true);
			blit();
		}
		
		function blit() {
			var temp = "";
			for(var i = 0; i < outputHeight; i++) {
				for(var j = 0; j < outputWidth; j++) {
					temp += o[j][i];
				}
				temp += "<br/>";
			}
			main.innerHTML = temp;
		}
		
		document.body.onload = function() { start() };
	</script>
</body>
</html>